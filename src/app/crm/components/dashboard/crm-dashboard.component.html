<!-- src/app/crm/dashboard/crm-dashboard.component.html -->
<div class="crm-dashboard-v3 container-fluid py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="text-primary mb-0">ğŸ“Š CRM + Finance Dashboard</h4>

    <div class="d-flex align-items-center gap-2">
      <small class="text-muted">Last updated: {{ lastUpdated | date:'short' }}</small>
      <button class="btn btn-outline-secondary btn-sm" (click)="refreshAll()" [disabled]="loading">
        <span *ngIf="!loading">ğŸ”„ Refresh</span>
        <span *ngIf="loading">â³ Loading...</span>
      </button>
      <div class="ms-2">
        <span class="badge bg-light text-dark">User: {{ currentUser.name }} ({{ currentUser.role }})</span>
      </div>
    </div>
  </div>

  <!-- Stat Cards (Existing CRM Totals) -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-4 col-sm-6" *ngFor="let s of stats">
      <div class="card stat-card h-100" [style.borderTopColor]="s.color" (click)="navigate(s.route)">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 fs-1">{{ s.icon }}</div>
          <div>
            <small class="text-muted">{{ s.title }}</small>
            <div class="h5 mb-0">{{ s.count }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ NEW: Finance + CRM Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ’° Collection Target</h6>
        <div class="h5 text-primary">â‚¹{{ financeStats.collectionTarget | number }}</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>âœ… Collection Actual</h6>
        <div class="h5 text-success">â‚¹{{ financeStats.collectionActual | number }}</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ  Occupancy Rate</h6>
        <div class="h5 text-info">{{ financeStats.occupancyRate }}%</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ† Incentives</h6>
        <div class="h5 text-success">â‚¹{{ financeStats.totalIncentive | number }}</div>
      </div>
    </div>
  </div>

  <!-- ğŸ”· Finance + CRM Charts -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ“Š Collection Progress vs Target</h6>
        <canvas id="collectionChart" class="dashboard-chart"></canvas>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card p-3">
        <h6>ğŸ’¼ Property Occupancy</h6>
        <canvas id="occupancyChart" class="dashboard-chart"></canvas>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card p-3">
        <h6>ğŸ”” Pending vs Collected Payments</h6>
        <canvas id="paymentsChart" class="dashboard-chart"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ‘¥ Active vs Dormant Leads</h6>
        <canvas id="leadsChart" class="dashboard-chart"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ§© Employee Performance</h6>
        <canvas id="employeeChart" class="dashboard-chart"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ§¾ Expenses Trend</h6>
        <canvas id="expenseChart"></canvas>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h6>ğŸ’¹ Revenue vs Target</h6>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ğŸ“… CRM: Upcoming, Overdue, Performers -->
  <div class="row g-3 mt-4">
    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">ğŸ“… Upcoming (7 days)</h6>
          <small class="text-muted">{{ upcomingTasks.length }} items</small>
        </div>

        <ul class="list-group list-group-flush">
          <li class="list-group-item" *ngFor="let t of upcomingTasks">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ t.title }}</div>
                <small class="text-muted">{{ t.module }} â€¢ {{ t.assignedTo }}</small>
              </div>
              <div class="text-end">
                <div><small>{{ t.dueDate | date:'shortDate' }}</small></div>
                <div><span class="badge bg-warning text-dark">{{ t.status }}</span></div>
              </div>
            </div>
          </li>
          <li *ngIf="upcomingTasks.length === 0" class="list-group-item text-muted">No upcoming tasks</li>
        </ul>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">âš ï¸ Overdue Tasks</h6>
          <small class="text-muted">{{ overdueTasks.length }} items</small>
        </div>

        <ul class="list-group list-group-flush">
          <li class="list-group-item" *ngFor="let t of overdueTasks">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold text-danger">{{ t.title }}</div>
                <small class="text-muted">{{ t.module }} â€¢ {{ t.assignedTo }}</small>
              </div>
              <div class="text-end">
                <div><small>{{ t.dueDate | date:'shortDate' }}</small></div>
                <div><span class="badge bg-danger">Overdue</span></div>
              </div>
            </div>
          </li>
          <li *ngIf="overdueTasks.length === 0" class="list-group-item text-muted">No overdue tasks</li>
        </ul>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary mb-2">ğŸ† Top Performers</h6>
          <small class="text-muted">This Week</small>
        </div>

        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let p of performers">
            <div>
              <div class="fw-semibold">{{ p.name }}</div>
              <small class="text-muted">Tasks closed: {{ p.closed }}</small>
            </div>
            <div class="fw-bold">{{ p.closed }}</div>
          </li>
          <li *ngIf="performers.length === 0" class="list-group-item text-muted">No data</li>
        </ul>

        <div class="mt-3" *ngIf="isAdmin()">
          <button class="btn btn-sm btn-outline-primary w-100">ğŸ“¤ Export Weekly Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ“‹ Final Summary Section -->
  <div class="row g-3 mt-4">
    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ“… Follow-Ups</h6>
        <div class="h5">{{ financeStats.pendingFollowups }} ğŸ”” / {{ financeStats.completedFollowups }} âœ…</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ§‘â€ğŸ¤â€ğŸ§‘ Attendance</h6>
        <div class="h5">{{ financeStats.attendancePercent }}%</div>
        <small class="text-muted">Present this week</small>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ§¾ Expenses</h6>
        <div class="h5 text-danger">â‚¹{{ financeStats.totalExpense | number }}</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card p-3 text-center shadow-sm">
        <h6>ğŸ’¼ Revenue (Month)</h6>
        <div class="h5 text-success">â‚¹{{ financeStats.collectionActual | number }}</div>
      </div>
    </div>
  </div>
</div>
